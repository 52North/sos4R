---
title: "sos4R: Wrapper Functions for easier SOS access"
author:
  name: "Daniel Nüst"
  affiliation: Institute for Geoinformatics, University of Münster, Germany.
  email: daniel.nuest@uni-muenster.de
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{sos4R-vignette-99-services}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`sos4R` includes a collection of convenience functions which wrap the complex SOS interface with its specific terms (e.g. FOI, procedure).
The wrapper function use more generic terms easily accessible for all users, especially without a strong knowledge of the OGC standards of the Sensor Web Enablement (see ["OGC SWE and SOS"](sos4R-vignette-02-ogc-sos.html) vignette for details).

In general, these functions always return an object of class `data.frame`, even if the result is only a list, in which case the `data.frame` has one column.

```{r setup}
library("sos4R")

niwaHydro <- SOS(url = "https://hydro-sos.niwa.co.nz/", binding = "KVP", useDCPs = FALSE, version = "2.0.0")
```

## `phenomena()`

The function `phenomena(..)` provides information about observed phenomena and time periods of data.

```{r phenomena}
phenomena <- phenomena(sos = niwaHydro)
str(phenomena)
```

```{r phenomena_table}
phenomena
```

The retrieved data can be extended to the time intervals and site identifier for which data is available.

```{r phenomena_include_time}
phenomena(sos = niwaHydro, includeTemporalBBox = TRUE)
```

```{r phenomena_include_siteid}
# not implemented
#phenomena(sos = niwaHydro, includeSiteId = TRUE)
```

```{r phenomena_include_all}
# not implemented
#phenomena(sos = niwaHydro, includeTemporalBBox = TRUE, includeSiteId = TRUE)
```

## `sites()`

The function `sites(..)` provides information about sites where observations are made, including metadata about the sites (e.g. location).

```{r sites}
sites(sos = niwaHydro)
```

To see all sites, even the ones without any data, use the `empty` parameter.

```{r sites_empty, eval=FALSE}
sites(sos = niwaHydro, empty = TRUE)
```

You can retrieve additional metadata about the phenomena and the time period for which data is available. 

```{r sites_metadata}
sites(sos = niwaHydro, includePhenomena = TRUE, includeTemporalBBox = TRUE)[1:3,]
```

You can filter sites using phenomena and temporal extent.

```{r sites_phenomena}
sites(sos = niwaHydro, phenomena = phenomena[2:3,])
```

```{r sites_time}
sites(sos = niwaHydro, begin = as.POSIXct("1904-01-01"), end = as.POSIXct("1905-12-31"))
```

The returned object is a `SpatialPointsDataFrame`.
It allows access to coordinates with coordinate reference system (CRS) and mapping.

```{r sites_coords}
sites <- sites(sos = niwaHydro)

sp::coordinates(sites)[1:3,]
```

```{r sites_structure}
str(sites)
```

```{r sites_bbox}
sp::bbox(sites)
```

```{r sites_map}
suppressPackageStartupMessages(library("mapview"))

mapview(sites)
```

## `siteList()`

The function `siteList(..)` provides information about observed phenomena at sites and the time periods when data is available.

```{r siteList}
siteList <- siteList(sos = niwaHydro)
str(siteList)
```

You can extend the information returned with these parameters:

- `empty` to also show sites without data
- `includePhenomena` to add phenomena to the table (boolean)
- `includeTemporalBBox` to also show the time when data is available (boolean)

```{r siteList_empty, eval=FALSE}
siteList(sos = sos, empty = TRUE)
```

```{r siteList_includes}
siteList(sos = niwaHydro, includePhenomena = TRUE, includeTemporalBBox = TRUE)
```

You can reduce the results with these parameters:

- `phenomena` is a vector of phenomena which must be measured at the sites
- `begin` and `end` define a time interval (date and time class objects) for which some data must be available (sites may have data outside the given interval)

```{r siteList_phenomena_time}
siteList(sos = niwaHydro,
         phenomena = phenomena$phenomenon[1:2],
         begin = as.POSIXct("1950-01-01"), end = as.POSIXct("1960-12-31"))
```

## `getData()`

The function `getData(..)` retrieves the actual data and returns them in ready-to-use data structures from the [`spacetime`](https://cran.r-project.org/package=spacetime) package.

The returned data can be limited by thematical, spatial, and temporal filters.
Thematical filtering (phenomena) support the values of the previous functions as inputs.
Spatial filters are either sites, or a bounding box.

```{r getData_single}
singleSite <- siteList$siteID[[1]]

# not implemented
#getData(sos = niwaHydro, phenomena = phenomena$phenomenon[[1]], sites = singleSite)
```

```{r getData_multiple}
multipleSites <- siteList$siteID[4:6]
# get data for all phenomena at three sites

# not implemented
#data <- getData(sos = niwaHydro, phenomena = phenomena, sites = multipleSites)
#str(data)
```

```{r getData_summary}
# not implemented
#summary(data)
```
