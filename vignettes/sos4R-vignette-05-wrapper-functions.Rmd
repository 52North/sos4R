---
title: "sos4R: Wrapper Functions for easier SOS access"
author:
  name: "Daniel Nüst"
  affiliation: Institute for Geoinformatics, University of Münster, Germany.
  email: daniel.nuest@uni-muenster.de
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{5. Convenient wrapper functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`sos4R` includes a collection of convenience functions which wrap the complex SOS interface with its specific terms (e.g. FOI, procedure).
The wrapper function use more generic terms easily accessible for all users, especially without a strong knowledge of the OGC standards of the Sensor Web Enablement (see ["OGC SWE and SOS"](sos4R-vignette-02-ogc-sos.html) vignette for details).

In general, these functions always return an object of class `data.frame`, even if the result is only a list, in which case the `data.frame` has one column.

```{r setup}
library("sos4R")

niwaHydro <- SOS(url = "https://hydro-sos.niwa.co.nz/", binding = "KVP", useDCPs = FALSE, version = "2.0.0")
```

## Phenomena

The function `phenomena(..)` provides information about observed phenomena and time periods of data.

```{r phenomena}
phenomena <- phenomena(sos = niwaHydro)
str(phenomena)
```

```{r phenomena_table}
phenomena
```

The retrieved data can be extended to the time intervals and site identifier for which data is available.

```{r phenomena_include_time}
phenomena(sos = niwaHydro, includeTemporalBBox = TRUE)
```

```{r phenomena_include_siteid}
# not implemented - https://github.com/52North/sos4R/issues/83
#phenomena(sos = niwaHydro, includeSiteId = TRUE)
```

You can also add both temporal extent and sites.

```{r phenomena_include_all}
# not implemented - https://github.com/52North/sos4R/issues/83
#phenomena(sos = niwaHydro, includeTemporalBBox = TRUE, includeSiteId = TRUE)
```

## Sites

The function `sites(..)` provides information about sites where observations are made, including metadata about the sites (e.g. location).
The returned object is a `SpatialPointsDataFrame`.

```{r sites}
sites <- sites(sos = niwaHydro)
sites
```

To see all sites, even the ones without any data, use the `empty` parameter.

```{r sites_empty, eval=FALSE}
sitesEmpty <- sites(sos = niwaHydro, empty = TRUE)
as.data.frame(sitesEmpty)[10:13,]
```

You can retrieve additional metadata about the phenomena and the time period for which data is available.
Including temporal extent implies inclusion of phenomena.
In the next chunks the object is coerced to a `date.frame` to get a tabular view.

```{r sites_metadata_phen}
sites_1_3 <- sites(sos = niwaHydro, includePhenomena = TRUE)[1:3,]
as.data.frame(sites_1_3)
```

```{r sites_metadata_temporal}
# not fully implemented - temporal extent missing, see https://github.com/52North/sos4R/issues/93
#as.data.frame(sites(sos = niwaHydro, includeTemporalBBox = TRUE)[1:3,])
```

You can filter sites using phenomena and temporal extent.

```{r sites_phenomena}
as.data.frame(sites(sos = niwaHydro, phenomena = phenomena[3,]))
```

```{r sites_time}
as.data.frame(sites(sos = niwaHydro, begin = as.POSIXct("1904-01-01"), end = as.POSIXct("1905-12-31")))
```

The `SpatialPointsDataFrame` allows access to coordinates with coordinate reference system (CRS).

```{r sites_coords}
sp::coordinates(sites)[1:3,]
```

```{r sites_projection}
sites@proj4string
```

```{r sites_bbox}
sp::bbox(sites)
```

This object can be directly used as input for various mapping libraries, e.g. `mapview`.

```{r sites_map}
suppressPackageStartupMessages(library("mapview"))

mapview(sites)
```

## Data at sites

The function `siteList(..)` provides information about observed phenomena at sites and the time periods when data is available.

```{r siteList}
siteList <- siteList(sos = niwaHydro)
str(siteList)
```

You can extend the information returned with these parameters:

- `empty` to also show sites without data
- `includePhenomena` to add phenomena to the table (boolean)
- `includeTemporalBBox` to also show the time when data is available (boolean)

```{r siteList_empty, eval=FALSE}
siteList(sos = niwaHydro, empty = TRUE)
```

```{r siteList_includes}
# under development - https://github.com/52North/sos4R/issues/90
#siteList(sos = niwaHydro, includePhenomena = TRUE, includeTemporalBBox = TRUE)
```

You can reduce the results with these parameters:

- `phenomena` is a vector of phenomena which must be measured at the sites
- `begin` and `end` define a time interval (date and time class objects) for which some data must be available (sites may have data outside the given interval)

```{r siteList_phenomena_time}
siteList(sos = niwaHydro,
         phenomena = phenomena$phenomenon[1:2], # no effect with current data
         begin = as.POSIXct("1950-01-01"), end = as.POSIXct("1960-12-31")
         )
```

## Data download

The function `getData(..)` retrieves the actual data and returns them in ready-to-use data structures from the [`spacetime`](https://cran.r-project.org/package=spacetime) package.

The returned data can be limited by thematical, spatial, and temporal filters.
Thematical filtering (phenomena) support the values of the previous functions as inputs.
Spatial filters are either sites, or a bounding box.
Temporal filter is a time period during which observations are made.

Without a temporal extent, the used SOS only returns the last measurement.

```{r getData_single}
observationData <- getData(sos = niwaHydro,
                           phenomena = phenomena$phenomenon[1],
                           sites = siteList$siteID[1],
                           retrieveFOI = FALSE, # TO BE FIXED
                           )

str(observationData)
```

The result `data.frame` includes additional metadata.

```{r getData_attributes}
attributes(observationData$`m^3/s`)
```

Request more data with a temporal extent for all sites.

```{r getData_temporal}
# under development - see https://github.com/52North/sos4R/issues/138 and https://github.com/52North/sos4R/issues/96
observationData <- getData(sos = niwaHydro,
                          phenomena = phenomena$phenomenon[1],
                          sites = siteList$siteID[1],
                          begin = as.POSIXct("2019-01-01"),
                          end = as.POSIXct("2019-01-02"),
                          inspect = F,
                          retrieveFOI = FALSE, # TO BE FIXED
                          )

str(observationData)

library(xts)
ts <- xts(as.numeric(observationData$Discharge), observationData$phenomenonTime)
plot(ts)
```

The next example gets data for two phenomena a site.

```{r getData_multipleA}
# TO BE IMPLEMENTED: merge different observation types - see https://github.com/52North/sos4R/issues/96#issuecomment-493424151
#getData(sos = niwaHydro,
#        phenomena = phenomena$phenomenon[1:2],
#        sites = siteList$siteID[1],
#        retrieveFOI = FALSE, # TO BE FIXED
#        )
#observationData <- getData(sos = niwaHydro, phenomena = phenomena, sites = multipleSites)
#str(observationData)
```


You can also retrieve data for phenomena from multiple sites.

```{r getData_multipleB}
multipleSites <- siteList$siteID[35:38]
# TO BE IMPLEMENTED: merge different observation types
#observationData <- getData(sos = niwaHydro, phenomena = phenomena, sites = multipleSites)
#str(observationData)
```


```{r getData_summary}
# not implemented
summary(observationData)
```
